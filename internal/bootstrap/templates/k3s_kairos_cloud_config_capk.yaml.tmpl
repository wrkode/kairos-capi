#cloud-config

{{- /* 
Template inputs (from Go):

  .Role              string   // "control-plane" or "worker"
  .SingleNode        bool     // true for single-node control-plane
  .Hostname          string   // explicit hostname (optional)
  .UserName          string   // e.g. "kairos"
  .UserPassword      string   // e.g. "kairos"
  .UserGroups        []string // e.g. ["admin"]
  .GitHubUser        string   // e.g. "YOUR_GITHUB_USER" (optional)
  .SSHPublicKey      string   // alternative to GitHubUser (optional)
  .K3sServerURL      string   // server URL for k3s agents
  .K3sToken          string   // used only for workers
  .Manifests         []Manifest // optional manifests
  .HostnamePrefix    string   // e.g. "metal-"
  .DNSServers        []string // optional DNS resolvers
  .Install           *InstallConfig // install configuration (optional)
  .ProviderID        string   // providerID for Node (e.g., "vsphere://<vm-uuid>")
*/ -}}

{{/* Hostname: prefer explicit name, else use hostname prefix with Kairos templating for machine ID */}}
{{/* The {{ trunc 4 .MachineID }} is Kairos templating syntax, output literally */}}
{{- if .Hostname }}
hostname: {{ .Hostname }}
{{- else if .HostnamePrefix }}
hostname: {{ .HostnamePrefix }}{{ "{{ trunc 4 .MachineID }}" }}
{{- end }}

{{- if .Install }}
install:
  auto: {{ .Install.Auto }}
  device: "{{ .Install.Device }}"
  reboot: {{ .Install.Reboot }}
{{- end }}

users:
- name: {{ .UserName }}
  passwd: {{ .UserPassword }}
  groups:
  {{- range .UserGroups }}
    - {{ . }}
  {{- end }}
  {{- if or .GitHubUser .SSHPublicKey }}
  ssh_authorized_keys:
  {{- if .GitHubUser }}
    - github:{{ .GitHubUser }}
  {{- end }}
  {{- if .SSHPublicKey }}
    - {{ .SSHPublicKey }}
  {{- end }}
  {{- end }}
- name: capk
  groups: [users, admin]

{{- if eq .Role "control-plane" }}

# Control-plane node configuration
k3s:
  enabled: true

{{- else }}

# Worker node configuration
k3s-agent:
  enabled: true
  args:
    - --server {{ .K3sServerURL }}
    - --token-file /etc/rancher/k3s/token

{{- end }}

{{- /* write_files: worker token + post-bootstrap service/script (like k0s CAPK) */}}
write_files:
  {{- if and (ne .Role "control-plane") .K3sToken }}
  - path: /etc/rancher/k3s/token
    permissions: "0644"
    content: |
      {{ .K3sToken }}
  {{- end }}
  {{- if or .Hostname .HostnamePrefix }}
  - path: /usr/local/etc/hostname
    permissions: "0644"
    owner: 0
    group: 0
    content: |
      {{- if .Hostname }}
      {{ .Hostname }}
      {{- else }}
      {{ .HostnamePrefix }}{{ "{{ trunc 4 .MachineID }}" }}
      {{- end }}
  {{- end }}
  - path: /etc/systemd/system/kairos-k3s-post-bootstrap.service
    permissions: "0644"
    owner: 0
    group: 0
    content: |
      [Unit]
      Description=Kairos k3s post-bootstrap tasks
      {{- if eq .Role "control-plane" }}
      After=k3s.service
      Wants=k3s.service
      {{- else }}
      After=k3s-agent.service
      Wants=k3s-agent.service
      {{- end }}
      
      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/local/bin/kairos-k3s-post-bootstrap.sh
      
      [Install]
      WantedBy=multi-user.target
  - path: /usr/local/bin/kairos-k3s-post-bootstrap.sh
    permissions: "0755"
    owner: 0
    group: 0
    content: |
      #!/bin/bash
      set -e
      
      {{- if .IsKubeVirt }}
      # CAPK: always mark bootstrap success on script exit
      mark_bootstrap_success() {
        mkdir -p /run/cluster-api
        echo "success" > /run/cluster-api/bootstrap-success.complete
        chmod 0644 /run/cluster-api/bootstrap-success.complete
      }
      trap mark_bootstrap_success EXIT
      {{- end }}
      
      {{- if .HostnamePrefix }}
      # Enforce hostname from cloud-config on immutable rootfs
      if [ -f /usr/local/etc/hostname ]; then
        /usr/bin/hostnamectl set-hostname "$(cat /usr/local/etc/hostname)"
        if ! grep -qE "127\.0\.1\.1[[:space:]]+$(cat /usr/local/etc/hostname)" /etc/hosts; then
          echo "127.0.1.1 $(cat /usr/local/etc/hostname)" >> /etc/hosts
        fi
      fi
      {{- end }}

      {{- if .Manifests }}
      # Write k3s manifests
      echo "Writing k3s manifests..."
      mkdir -p /var/lib/rancher/k3s/server/manifests
      {{- range .Manifests }}
      mkdir -p /var/lib/rancher/k3s/server/manifests/{{ .Name }}
      cat > /var/lib/rancher/k3s/server/manifests/{{ .Name }}/{{ .File }} << 'MANIFEST_EOF'
{{ .Content }}
MANIFEST_EOF
      chmod 0644 /var/lib/rancher/k3s/server/manifests/{{ .Name }}/{{ .File }}
      echo "Written manifest: /var/lib/rancher/k3s/server/manifests/{{ .Name }}/{{ .File }}"
      {{- end }}
      {{- end }}
      
      {{- if .ProviderID }}
      # Wait for k3s API to be ready
      echo "Waiting for k3s API to be ready..."
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      for i in {1..60}; do
        if [ -f /etc/rancher/k3s/k3s.yaml ] && k3s kubectl get --raw /readyz &>/dev/null; then
          break
        fi
        echo "Waiting for k3s API... (${i}/60)"
        sleep 5
      done
      
      # Set providerID on the Node
      echo "Setting providerID={{ .ProviderID }} on node $(hostname)..."
      PROVIDER_ID_SET=false
      for i in {1..30}; do
        if k3s kubectl patch node $(hostname) --type=merge -p '{"spec":{"providerID":"{{ .ProviderID }}"}}' &>/dev/null; then
          echo "Successfully set providerID={{ .ProviderID }} on node $(hostname)"
          PROVIDER_ID_SET=true
          break
        fi
        echo "Attempt $i/30: Failed to set providerID, retrying in 5 seconds..."
        sleep 5
      done
      
      if [ "$PROVIDER_ID_SET" != "true" ]; then
        echo "ERROR: Failed to set providerID after 30 attempts"
        exit 1
      fi
      {{- else }}
      echo "No providerID to set"
      {{- end }}
      
      # Mark bootstrap success for CAPI/CAPK consumers
      mkdir -p /run/cluster-api
      echo "success" > /run/cluster-api/bootstrap-success.complete
      chmod 0644 /run/cluster-api/bootstrap-success.complete
      
      echo "k3s post-bootstrap tasks completed successfully"

{{- /* DNS overrides and bootstrap stages */}}
stages:
  boot:
    - name: "Ensure SSH service is enabled"
      commands:
        - systemctl enable --now sshd || systemctl enable --now ssh || true
    - name: "Allow SSH password authentication"
      files:
        - path: /etc/ssh/sshd_config.d/60-kairos-capi.conf
          permissions: "0644"
          owner: 0
          group: 0
          content: |
            PasswordAuthentication yes
            KbdInteractiveAuthentication yes
      commands:
        - mkdir -p /etc/ssh/sshd_config.d
        - systemctl restart sshd || systemctl restart ssh || true
    - name: "Ensure k3s directories exist"
      commands:
        - mkdir -p /etc/rancher/k3s
    {{- if .DNSServers }}
    - name: "Configure DNS resolvers for early boot"
      dns:
        nameservers:
        {{- range .DNSServers }}
          - {{ . }}
        {{- end }}
        path: "/etc/resolv.conf"
    {{- end }}

runcmd:
  - /bin/systemctl daemon-reload || true
  - /bin/systemctl enable kairos-k3s-post-bootstrap.service || true
