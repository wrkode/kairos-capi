#cloud-config

{{- /* 
Template inputs (from Go):

  .Role              string   // "control-plane" or "worker"
  .SingleNode        bool     // true for single-node k0s (controller-only)
  .UserName          string   // e.g. "kairos"
  .UserPassword      string   // e.g. "kairos"
  .UserGroups        []string // e.g. ["admin"]
  .GitHubUser        string   // e.g. "YOUR_GITHUB_USER" (optional)
  .SSHPublicKey      string   // alternative to GitHubUser (optional)
  .WorkerToken       string   // used only for workers
  .Manifests         []Manifest // optional manifests
  .HostnamePrefix    string   // e.g. "metal-"
  .Install           *InstallConfig // install configuration (optional)
*/ -}}

{{/* Hostname: we want to preserve Kairos templating: metal-{{ trunc 4 .MachineID }} */}}
hostname: {{ .HostnamePrefix }}{{"{{ trunc 4 .MachineID }}"}}

{{- if .Install }}
install:
  auto: {{ .Install.Auto }}
  device: "{{ .Install.Device }}"
  reboot: {{ .Install.Reboot }}
{{- end }}

users:
- name: {{ .UserName }}
  passwd: {{ .UserPassword }}
  groups:
  {{- range .UserGroups }}
    - {{ . }}
  {{- end }}
  {{- if or .GitHubUser .SSHPublicKey }}
  ssh_authorized_keys:
  {{- if .GitHubUser }}
    - github:{{ .GitHubUser }}
  {{- end }}
  {{- if .SSHPublicKey }}
    - {{ .SSHPublicKey }}
  {{- end }}
  {{- end }}

{{- if eq .Role "control-plane" }}

# Control-plane node configuration
k0s:
  enabled: true
  {{- if .SingleNode }}
  args:
    - --single
  {{- end }}

{{- else }}

# Worker node configuration
k0s-worker:
  enabled: true
  args:
    - --token-file /etc/k0s/token

write_files:
  - path: /etc/k0s/token
    permissions: "0644"
    content: |
      {{ .WorkerToken }}

{{- end }}

{{- if .Manifests }}

# Optional extra manifests to be applied by k0s from /var/lib/k0s/manifests
write_files:
{{- range .Manifests }}
  - path: /var/lib/k0s/manifests/{{ .Name }}/{{ .File }}
    permissions: "0644"
    content: |
{{ .Content | indent 6 }}
{{- end }}

{{- end }}

